name: build-linux

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        flavor: [native, portable]

    env:
      BUILD_TYPE: Release
      CC: gcc-12
      CXX: g++-12
      SQUASH_PREFIX: /usr/local

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build deps
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build pkg-config ccache \
            gcc-12 g++-12 \
            ragel libglib2.0-dev \
            zlib1g-dev libbz2-dev liblzma-dev \
            liblz4-dev libzstd-dev libsnappy-dev libbrotli-dev \
            binutils patchelf

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ runner.os }}-${{ matrix.flavor }}-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.flavor }}-${{ github.ref }}-
            ccache-${{ runner.os }}-${{ matrix.flavor }}-

      - name: Configure ccache
        run: |
          set -euxo pipefail
          ccache --set-config=cache_dir=$HOME/.cache/ccache
          ccache --set-config=max_size=500M
          ccache --zero-stats

      # --------------------------
      # Checkout Squash correctly (NO manual git clone)
      # --------------------------
      - name: Checkout Squash (with submodules)
        uses: actions/checkout@v4
        with:
          repository: quixdb/squash
          path: _deps/squash
          submodules: recursive
          fetch-depth: 1

      - name: Sanity check Squash submodules
        run: |
          set -euxo pipefail
          test -f _deps/squash/plugins/zlib-ng/zlib-ng/zconf.h.in

      - name: Build & install Squash (shared + plugins)
        run: |
          set -euxo pipefail
          cmake -S _deps/squash -B _deps/squash/build-shared -G Ninja \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX=${SQUASH_PREFIX}
          cmake --build _deps/squash/build-shared -j
          sudo cmake --install _deps/squash/build-shared
          sudo ldconfig

          ls -la ${SQUASH_PREFIX}/include/squash-0.8 || true
          ls -la ${SQUASH_PREFIX}/lib | sed -n '1,200p' || true

      # Optional: build libsquash0.8.a (best-effort)
      - name: Build Squash static archive (best effort)
        run: |
          set -euxo pipefail

          cmakefile="$(grep -RIlE 'add_library\\s*\\(\\s*squash0\\.8\\s+SHARED' _deps/squash || true)"
          if [ -z "$cmakefile" ]; then
            echo "WARN: couldn't find add_library(squash0.8 SHARED ...) to patch; skipping static build"
            exit 0
          fi

          sed -i -E 's/(add_library\\s*\\(\\s*squash0\\.8)\\s+SHARED/\\1 STATIC/' "$cmakefile"

          cmake -S _deps/squash -B _deps/squash/build-static -G Ninja \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX=${SQUASH_PREFIX}
          cmake --build _deps/squash/build-static -j

          archive="$(find _deps/squash/build-static -name 'libsquash0.8.a' -print -quit || true)"
          if [ -n "$archive" ]; then
            sudo install -Dm644 "$archive" ${SQUASH_PREFIX}/lib/libsquash0.8.a
            echo "Installed static archive: ${SQUASH_PREFIX}/lib/libsquash0.8.a"
          else
            echo "WARN: static archive not produced; continuing"
          fi

      # --------------------------
      # Build your project (native vs portable)
      # --------------------------
      - name: Patch project flags for portability (portable only)
        if: matrix.flavor == 'portable'
        run: |
          set -euxo pipefail
          # Replace -march=native -mtune=native with a baseline that runs on most x86_64 machines
          sed -i \
            -e 's/-march=native -mtune=native/-march=x86-64-v2 -mtune=generic/g' \
            CMakeLists.txt || true

      - name: Configure project
        run: |
          set -euxo pipefail
          cmake -S . -B build-${{ matrix.flavor }} -G Ninja \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_C_COMPILER=${CC} \
            -DCMAKE_CXX_COMPILER=${CXX} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build project
        run: |
          set -euxo pipefail
          cmake --build build-${{ matrix.flavor }} -j

      - name: Show one compile command (sanity)
        run: |
          set -euxo pipefail
          python3 - << 'PY'
          import json, pathlib
          p = pathlib.Path("build-${{ matrix.flavor }}/compile_commands.json")
          if not p.exists():
            print("No compile_commands.json found")
            raise SystemExit(0)
          db = json.loads(p.read_text())
          print(db[0]["command"][:4000])
          PY

      # --------------------------
      # Bundle: binary + ./lib so it runs on servers without Squash installed
      # --------------------------
      - name: Bundle runtime (binary + libs + Squash plugins)
        run: |
          set -euxo pipefail

          BIN="build-${{ matrix.flavor }}/LosslessBenchmarkFull"
          if [ ! -f "$BIN" ]; then
            echo "ERROR: $BIN not produced. Check Squash detection at /usr/local/include/squash-0.8"
            ls -la build-${{ matrix.flavor }} || true
            exit 1
          fi

          OUT="bundle-${{ matrix.flavor }}"
          rm -rf "$OUT"
          mkdir -p "$OUT/lib"
          cp -v "$BIN" "$OUT/LosslessBenchmarkFull"

          echo "RPATH/RUNPATH:"
          readelf -d "$OUT/LosslessBenchmarkFull" | egrep -i 'rpath|runpath' || true

          # Copy shared library dependencies except core system libs
          ldd "$OUT/LosslessBenchmarkFull" | awk '{print $3}' | grep -E '^/' | sort -u > /tmp/ldd_libs.txt || true
          while read -r lib; do
            base="$(basename "$lib")"
            case "$base" in
              ld-linux*|libc.so.*|libm.so.*|libpthread.so.*|librt.so.*|libdl.so.*)
                continue
                ;;
            esac
            cp -vL "$lib" "$OUT/lib/" || true
          done < /tmp/ldd_libs.txt

          # Squash core lib
          cp -vL /usr/local/lib/libsquash0.8.so* "$OUT/lib/" 2>/dev/null || true

          # Squash plugins (common paths)
          find /usr/local/lib -maxdepth 6 -type f -name "*.so*" -path "*/squash/*" \
            -print -exec cp -vL {} "$OUT/lib/" \; || true

          echo "Bundled files:"
          (cd "$OUT" && find . -maxdepth 2 -type f -print)

      - name: Archive bundle
        run: |
          set -euxo pipefail
          tar -czf NeaTS-linux-${{ matrix.flavor }}.tar.gz bundle-${{ matrix.flavor }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: NeaTS-linux-${{ matrix.flavor }}
          path: NeaTS-linux-${{ matrix.flavor }}.tar.gz

      - name: ccache stats
        if: always()
        run: |
          ccache --show-stats
