name: build-linux-targeted

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  build-centos7-skylake:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. Create the Build Script (Run inside Docker)
      - name: Create Build Script
        run: |
          cat << 'EOF' > build_internal.sh
          #!/bin/bash
          set -eo pipefail 

          # --- CLEANUP ---
          rm -rf squash-0.7.0 build-skylake NeaTS-CentOS7-Skylake

          # --- FIX REPOS ---
          rm -f /etc/yum.repos.d/*.repo
          cat << 'REPO' > /etc/yum.repos.d/CentOS-Vault.repo
          [base]
          name=CentOS-7 - Base
          baseurl=http://vault.centos.org/7.9.2009/os/x86_64/
          gpgcheck=0
          [updates]
          name=CentOS-7 - Updates
          baseurl=http://vault.centos.org/7.9.2009/updates/x86_64/
          gpgcheck=0
          REPO
          yum install -y bzip2 wget

          # --- INSTALL MICROMAMBA & COMPILERS ---
          wget -qO- https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xj -C /usr/local/bin --strip-components=1 bin/micromamba
          export MAMBA_ROOT_PREFIX=/opt/conda
          
          # Main build environment with GCC 13 + Clang
          # libc++ needed for LeCo (avoids libstdc++ type_traits conflicts)
          micromamba create -y -n build-env -c conda-forge \
            gcc_linux-64=13 gxx_linux-64=13 \
            clang clangxx libcxx llvm-openmp \
            cmake ninja pkg-config make \
            ragel patchelf \
            brotli zlib lz4-c zstd snappy xz bzip2 \
            liblzma-devel \
            boost-cpp gmp eigen

          # --- ACTIVATE ENVIRONMENT ---
          set +u
          eval "$(micromamba shell hook -s bash)"
          micromamba activate build-env
          set -u

          # --- CONFIGURE COMPILER PATHS ---
          ENV_PATH="/opt/conda/envs/build-env"
          export CFLAGS="-I$ENV_PATH/include -fno-openmp $CFLAGS"
          export CXXFLAGS="-I$ENV_PATH/include -fno-openmp $CXXFLAGS"
          export LDFLAGS="-L$ENV_PATH/lib -Wl,-rpath,$ENV_PATH/lib $LDFLAGS"
          export PKG_CONFIG_PATH="$ENV_PATH/lib/pkgconfig:$PKG_CONFIG_PATH"
          
          # Fix missing snappy.pc
          mkdir -p $ENV_PATH/lib/pkgconfig
          cat << PC > $ENV_PATH/lib/pkgconfig/snappy.pc
          prefix=$ENV_PATH
          exec_prefix=\${prefix}
          libdir=\${prefix}/lib
          includedir=\${prefix}/include
          Name: snappy
          Description: Snappy
          Version: 1.1.10
          Libs: -L\${libdir} -lsnappy
          Cflags: -I\${includedir}
          PC

          # --- BUILD SQUASH 0.7.0 (with GCC default) ---
          export SQUASH_PREFIX=/usr/local
          export TARGET_ARCH="-march=skylake-avx512 -mtune=skylake-avx512"
          
          wget https://github.com/quixdb/squash/releases/download/v0.7.0/squash-0.7.0.tar.bz2
          tar -xjf squash-0.7.0.tar.bz2
          cd squash-0.7.0
          
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${SQUASH_PREFIX} \
            -DCMAKE_C_FLAGS="${TARGET_ARCH} ${CFLAGS} -w" \
            -DCMAKE_CXX_FLAGS="${TARGET_ARCH} ${CXXFLAGS} -w" \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build build -j
          make -C build install || cmake --install build
          
          # Copy libs to conda env so bundle picks them up
          if [ -d "${SQUASH_PREFIX}/lib64" ]; then
             cp -v ${SQUASH_PREFIX}/lib64/libsquash* $ENV_PATH/lib/ || true
          else
             cp -v ${SQUASH_PREFIX}/lib/libsquash* $ENV_PATH/lib/ || true
          fi
          cd /workspace

          # --- PATCH LECO HEADERS ---
          # LeCo has bugs: 1) redefines std::is_integral<__uint128_t> etc. (already in libstdc++)
          #                2) uses deprecated 'register' keyword
          # We patch these in-place since LeCo is a submodule
          
          # Patch 1: Comment out the type_traits specializations (lines 11-25 in leco_uint256.h)
          # These are already defined in modern libstdc++ (GCC 4.6+)
          sed -i '11,25s/^/\/\/ PATCHED: /' lib/Learn-to-Compress/headers/string/leco_uint256.h
          
          # Patch 2: Remove deprecated 'register' keyword
          sed -i 's/register uint64_t/uint64_t/g' lib/Learn-to-Compress/headers/popcount.h
          
          # --- BUILD PROJECT (GCC) ---
          echo "Building with GCC..."
          cmake -S . -B build-gcc -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DARCH_FLAGS="${TARGET_ARCH}" \
            -DCMAKE_C_COMPILER="$ENV_PATH/bin/x86_64-conda-linux-gnu-gcc" \
            -DCMAKE_CXX_COMPILER="$ENV_PATH/bin/x86_64-conda-linux-gnu-g++" \
            -DNEATS_WITH_SQUASH=ON \
            -DNEATS_WITH_LECO=ON \
            -DNEATS_LECO_EXTRA_INCLUDES="$ENV_PATH/include;$ENV_PATH/include/eigen3" \
            -DNEATS_ALP_HYBRID_CLANG=ON \
            -DNEATS_ALP_CLANGXX="$ENV_PATH/bin/clang++" \
            -DCMAKE_DISABLE_FIND_PACKAGE_OpenMP=TRUE
          cmake --build build-gcc -j

          # --- BUILD PROJECT (Clang) ---
          echo "Building with Clang..."
          cmake -S . -B build-clang -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DARCH_FLAGS="${TARGET_ARCH}" \
            -DCMAKE_C_COMPILER="$ENV_PATH/bin/clang" \
            -DCMAKE_CXX_COMPILER="$ENV_PATH/bin/clang++" \
            -DCMAKE_CXX_SCAN_FOR_MODULES=OFF \
            -DNEATS_WITH_SQUASH=ON \
            -DNEATS_WITH_LECO=ON \
            -DNEATS_LECO_EXTRA_INCLUDES="$ENV_PATH/include;$ENV_PATH/include/eigen3" \
            -DNEATS_ALP_HYBRID_CLANG=OFF \
            -DCMAKE_DISABLE_FIND_PACKAGE_OpenMP=TRUE
          cmake --build build-clang -j

          # --- BUNDLE ---
          OUT="NeaTS-CentOS7-Skylake"
          
          rm -rf "$OUT"
          mkdir -p "$OUT/lib"
          
          # Copy binaries from GCC build
          if [ -f "build-gcc/LosslessBenchmarkFull" ]; then
             cp -v "build-gcc/LosslessBenchmarkFull" "$OUT/LosslessBenchmarkFull-gcc"
             cp -v "build-gcc/LosslessBenchmarkFullNoSIMD" "$OUT/LosslessBenchmarkFullNoSIMD-gcc"
          else
             echo "GCC binaries not found!" && exit 1
          fi

          # Copy binaries from Clang build
          if [ -f "build-clang/LosslessBenchmarkFull" ]; then
             cp -v "build-clang/LosslessBenchmarkFull" "$OUT/LosslessBenchmarkFull-clang"
             cp -v "build-clang/LosslessBenchmarkFullNoSIMD" "$OUT/LosslessBenchmarkFullNoSIMD-clang"
          else
             echo "Clang binaries not found!" && exit 1
          fi

          # Set RPATHs for all binaries
          patchelf --set-rpath '$ORIGIN/lib' "$OUT/LosslessBenchmarkFull-gcc"
          patchelf --set-rpath '$ORIGIN/lib' "$OUT/LosslessBenchmarkFullNoSIMD-gcc"
          patchelf --set-rpath '$ORIGIN/lib' "$OUT/LosslessBenchmarkFull-clang"
          patchelf --set-rpath '$ORIGIN/lib' "$OUT/LosslessBenchmarkFullNoSIMD-clang"

          # 1. FLATTEN SQUASH PLUGINS
          mkdir -p "$OUT/lib/plugins"
          if [ -d "/usr/local/lib64/squash" ]; then
              SQUASH_INSTALL_DIR="/usr/local/lib64/squash"
          elif [ -d "/usr/local/lib/squash" ]; then
              SQUASH_INSTALL_DIR="/usr/local/lib/squash"
          else
              echo "Error: Could not find Squash installation directory"
              exit 1
          fi
          SRC_PLUGIN_DIR=$(find "$SQUASH_INSTALL_DIR" -type d -name "plugins" | head -n 1)
          if [ -n "$SRC_PLUGIN_DIR" ]; then
             cp -r "$SRC_PLUGIN_DIR"/* "$OUT/lib/plugins/"
          else
             echo "WARNING: No plugins found!"
          fi

          # 2. RESOLVE DEPENDENCIES
          echo "Resolving dependencies..."
          find "$OUT" -type f \( -name "LosslessBenchmarkFull*" -o -name "*.so" \) > binaries.txt
          
          cat binaries.txt | xargs ldd | awk '{print $3}' | grep -E '^/' | sort -u > libs_to_copy.txt
          
          echo "Manually finding compressor libraries..."
          find /usr/lib /usr/lib64 /usr/local/lib /usr/local/lib64 $ENV_PATH/lib -name "libbrotlienc.so*" >> libs_to_copy.txt
          find /usr/lib /usr/lib64 /usr/local/lib /usr/local/lib64 $ENV_PATH/lib -name "libbrotlidec.so*" >> libs_to_copy.txt
          find /usr/lib /usr/lib64 /usr/local/lib /usr/local/lib64 $ENV_PATH/lib -name "libbrotlicommon.so*" >> libs_to_copy.txt
          find /usr/lib /usr/lib64 /usr/local/lib /usr/local/lib64 $ENV_PATH/lib -name "liblz4.so*" >> libs_to_copy.txt
          find /usr/lib /usr/lib64 /usr/local/lib /usr/local/lib64 $ENV_PATH/lib -name "libzstd.so*" >> libs_to_copy.txt
          find /usr/lib /usr/lib64 /usr/local/lib /usr/local/lib64 $ENV_PATH/lib -name "libsnappy.so*" >> libs_to_copy.txt
          find /usr/lib /usr/lib64 /usr/local/lib /usr/local/lib64 $ENV_PATH/lib -name "liblzma.so*" >> libs_to_copy.txt
          
          sort -u libs_to_copy.txt | while read -r lib; do
            base="$(basename "$lib")"
            case "$base" in
              ld-linux*|libc.so.*|libm.so.*|libpthread.so.*|librt.so.*|libdl.so.*)
                continue ;;
            esac
            cp -vL "$lib" "$OUT/lib/" || true
          done

          # 3. FIX SYMLINKS
          /sbin/ldconfig -n "$OUT/lib"

          # 4. CREATE RUN SCRIPTS
          # Helper function for run scripts
          create_run_script() {
              local suffix=$1
              local binary=$2
              cat << WRAPPER > "$OUT/run_${suffix}.sh"
          #!/bin/bash
          HERE="\$(dirname "\$(readlink -f "\$0")")"
          export SQUASH_PLUGIN_PATH="\$HERE/lib/plugins"
          export SQUASH_PLUGINS_PATH="\$HERE/lib/plugins"
          export SQUASH_PLUGINS="\$HERE/lib/plugins"
          export SQUASH_PLUGIN_DIR="\$HERE/lib/plugins"
          export LD_LIBRARY_PATH="\$HERE/lib:\$LD_LIBRARY_PATH"
          exec "\$HERE/${binary}" "\$@"
          WRAPPER
              chmod +x "$OUT/run_${suffix}.sh"
          }

          create_run_script "gcc" "LosslessBenchmarkFull-gcc"
          create_run_script "gcc_nosimd" "LosslessBenchmarkFullNoSIMD-gcc"
          create_run_script "clang" "LosslessBenchmarkFull-clang"
          create_run_script "clang_nosimd" "LosslessBenchmarkFullNoSIMD-clang"

          # Default run.sh -> GCC optimized
          cp "$OUT/run_gcc.sh" "$OUT/run.sh"
          
          chown -R $(id -u):$(id -g) "$OUT"
          EOF
          
          chmod +x build_internal.sh

      # 2. Run Build in Docker
      - name: Run Build in Docker (CentOS 7)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            quay.io/pypa/manylinux2014_x86_64:latest \
            /bin/bash /workspace/build_internal.sh

      # 3. Upload Artifact
      - name: Upload Bundle
        uses: actions/upload-artifact@v4
        with:
          name: NeaTS-CentOS7-Skylake
          path: NeaTS-CentOS7-Skylake
          compression-level: 9
