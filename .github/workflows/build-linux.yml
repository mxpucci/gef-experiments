name: build-linux-targeted

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  build-centos7-skylake:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. Create the Build Script (Run inside Docker)
      - name: Create Build Script
        run: |
          cat << 'EOF' > build_internal.sh
          #!/bin/bash
          set -euxo pipefail

          # --- CONFIGURATION ---
          export PATH=/opt/rh/devtoolset-10/root/usr/bin:$PATH
          export CC=/opt/rh/devtoolset-10/root/usr/bin/gcc
          export CXX=/opt/rh/devtoolset-10/root/usr/bin/g++
          export SQUASH_PREFIX=/usr/local
          export TARGET_ARCH="-march=skylake-avx512 -mtune=skylake-avx512"

          # --- INSTALL DEPS ---
          # 1. devtoolset-10-libstdc++-devel: FIXES 'experimental/simd: No such file'
          # 2. brotli-devel: Fixes Squash plugin requirement
          # 3. ragel: Fixes Squash build requirement
          yum install -y cmake3 ninja-build libtool \
            devtoolset-10-libstdc++-devel devtoolset-10-gcc-c++ \
            zlib-devel bzip2-devel xz-devel lz4-devel libzstd-devel snappy-devel \
            brotli-devel ragel \
            glib2-devel wget which

          ln -sf /usr/bin/cmake3 /usr/bin/cmake

          # --- FIX: MANUALLY CREATE SNAPPY.PC ---
          # CentOS 7 snappy-devel is broken/incomplete. Fix pkg-config manually.
          cat << 'PC' > /usr/lib64/pkgconfig/snappy.pc
          prefix=/usr
          exec_prefix=/usr
          libdir=/usr/lib64
          includedir=/usr/include

          Name: snappy
          Description: Snappy compression library
          Version: 1.1.0
          Libs: -L${libdir} -lsnappy
          Cflags: -I${includedir}
          PC
          export PKG_CONFIG_PATH=/usr/lib64/pkgconfig:${PKG_CONFIG_PATH:-}

          # --- DOWNLOAD & BUILD SQUASH 0.7.0 ---
          # Using tarball avoids git submodule hell
          wget https://github.com/quixdb/squash/releases/download/v0.7.0/squash-0.7.0.tar.bz2
          tar -xjf squash-0.7.0.tar.bz2
          
          cd squash-0.7.0
          
          # Configure Squash
          # -w disables warnings to keep logs clean
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${SQUASH_PREFIX} \
            -DCMAKE_C_FLAGS="${TARGET_ARCH} -w" \
            -DCMAKE_CXX_FLAGS="${TARGET_ARCH} -w" \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
            
          cmake --build build -j
          make -C build install || cmake --install build
          
          # Register libs
          echo "${SQUASH_PREFIX}/lib" > /etc/ld.so.conf.d/squash.conf
          ldconfig
          
          cd /workspace

          # --- BUILD YOUR PROJECT ---
          cmake -S . -B build-skylake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DARCH_FLAGS="${TARGET_ARCH}" \
            -DNEATS_WITH_SQUASH=ON

          cmake --build build-skylake -j

          # --- BUNDLE ---
          BIN="build-skylake/LosslessBenchmarkFull"
          OUT="NeaTS-CentOS7-Skylake"
          
          rm -rf "$OUT"
          mkdir -p "$OUT/lib/squash"
          
          cp -v "$BIN" "$OUT/LosslessBenchmarkFull"
          
          # Install patchelf
          yum install -y patchelf || true
          if command -v patchelf; then
             patchelf --set-rpath '$ORIGIN/lib' "$OUT/LosslessBenchmarkFull"
          fi

          # Copy dependencies
          ldd "$OUT/LosslessBenchmarkFull" | awk '{print $3}' | grep -E '^/' | sort -u > /tmp/libs.txt || true
          while read -r lib; do
            base="$(basename "$lib")"
            case "$base" in
              ld-linux*|libc.so.*|libm.so.*|libpthread.so.*|librt.so.*|libdl.so.*|libstdc++*|libgcc_s*)
                continue ;;
            esac
            cp -vL "$lib" "$OUT/lib/" || true
          done < /tmp/libs.txt

          # Copy Squash plugins (handle both lib and lib64 cases)
          if [ -d "/usr/local/lib64/squash" ]; then
              cp -r /usr/local/lib64/squash/* "$OUT/lib/squash/" || true
          else
              cp -r /usr/local/lib/squash/* "$OUT/lib/squash/" || true
          fi
          
          # Wrapper Script
          cat << 'WRAPPER' > "$OUT/run.sh"
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "$0")")"
          export SQUASH_PATH="$HERE/lib/squash"
          export LD_LIBRARY_PATH="$HERE/lib:$LD_LIBRARY_PATH"
          exec "$HERE/LosslessBenchmarkFull" "$@"
          WRAPPER
          chmod +x "$OUT/run.sh"
          
          chown -R $(id -u):$(id -g) "$OUT"
          EOF
          
          chmod +x build_internal.sh

      # 2. Run Build in Docker (CentOS 7)
      - name: Run Build in Docker (CentOS 7)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            quay.io/pypa/manylinux2014_x86_64:latest \
            /bin/bash /workspace/build_internal.sh

      # 3. Upload Artifact
      - name: Upload Bundle
        uses: actions/upload-artifact@v4
        with:
          name: NeaTS-CentOS7-Skylake
          path: NeaTS-CentOS7-Skylake
          compression-level: 9