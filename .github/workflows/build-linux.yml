name: build-linux-squash-static

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Static Binary in Alpine
        run: |
          # We use Docker to run the build inside Alpine, ensuring a static binary (musl)
          # that runs on any Linux VPS regardless of glibc version.
          docker run --rm -v "$PWD":/workspace -w /workspace alpine:latest sh -c "
            set -e
            
            # 1. Install GCC 13 (Alpine uses current GCC), CMake, and build tools
            #    We also install the STATIC versions of the compression libs.
            apk update
            apk add --no-cache \
              build-base cmake git \
              linux-headers \
              lz4-dev lz4-static \
              zstd-dev zstd-static \
              brotli-dev brotli-static \
              snappy-dev snappy-static \
              xz-dev xz-static \
              zlib-dev zlib-static \
              bzip2-dev bzip2-static

            echo '=== GCC Version ==='
            g++ --version

            # 2. Build Squash Library (Static)
            echo '=== Building Squash (Static) ==='
            rm -rf /tmp/squash
            git clone --depth 1 https://github.com/quixdb/squash.git /tmp/squash
            cd /tmp/squash
            
            # Initialize minimal submodules
            git submodule update --init squash/hedley || true
            git submodule update --init squash/tinycthread || true
            
            # Disable utils/tests to avoid extra deps
            sed -i 's/^[[:space:]]*add_subdirectory (utils)/# add_subdirectory (utils)/' CMakeLists.txt
            sed -i 's/^[[:space:]]*add_subdirectory (tests)/# add_subdirectory (tests)/' CMakeLists.txt

            mkdir -p builddir && cd builddir
            
            # IMPORTANT: -DBUILD_SHARED_LIBS=OFF creates .a files instead of .so
            cmake .. \\
              -DCMAKE_BUILD_TYPE=Release \\
              -DCMAKE_INSTALL_PREFIX=/usr/local \\
              -DBUILD_TESTING=OFF \\
              -DBUILD_SHARED_LIBS=OFF \\
              -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \\
              -DFORCE_EXTERNAL_LZ4=ON \\
              -DFORCE_EXTERNAL_ZSTD=ON \\
              -DFORCE_EXTERNAL_ZLIB=ON \\
              -DFORCE_EXTERNAL_SNAPPY=ON \\
              -DFORCE_EXTERNAL_BROTLI=ON \\
              -DFORCE_EXTERNAL_LZMA=ON \\
              -DFORCE_EXTERNAL_BZIP2=ON \\
              -DENABLE_BRIEFLZ=OFF \\
              -DENABLE_BSC=OFF \\
              -DENABLE_COPY=OFF \\
              -DENABLE_CRUSH=OFF \\
              -DENABLE_CSC=OFF \\
              -DENABLE_DENSITY=OFF \\
              -DENABLE_DOBOZ=OFF \\
              -DENABLE_FARI=OFF \\
              -DENABLE_FASTLZ=OFF \\
              -DENABLE_GIPFELI=OFF \\
              -DENABLE_HEATSHRINK=OFF \\
              -DENABLE_LIBDEFLATE=OFF \\
              -DENABLE_LZF=OFF \\
              -DENABLE_LZFSE=OFF \\
              -DENABLE_LZG=OFF \\
              -DENABLE_LZHAM=OFF \\
              -DENABLE_LZJB=OFF \\
              -DENABLE_LZO=OFF \\
              -DENABLE_MINIZ=OFF \\
              -DENABLE_MS_COMPRESS=OFF \\
              -DENABLE_NCOMPRESS=OFF \\
              -DENABLE_PITHY=OFF \\
              -DENABLE_QUICKLZ=OFF \\
              -DENABLE_WFLZ=OFF \\
              -DENABLE_YALZ77=OFF \\
              -DENABLE_ZLIB_NG=OFF \\
              -DENABLE_ZLING=OFF \\
              -DENABLE_ZPAQ=OFF

            make -j\$(nproc)
            make install
            
            # Verify static lib exists
            if [ -f \"/usr/local/lib/libsquash0.8.a\" ]; then
               echo '✓ libsquash0.8.a found'
            else
               echo '❌ libsquash0.8.a NOT found'
               exit 1
            fi

            # Return to workspace
            cd /workspace

            # 3. Configure Benchmark
            # We pass -static to force the compiler to link everything into one file
            echo '=== Building Benchmark ==='
            mkdir -p build && cd build
            cmake .. \\
              -DCMAKE_BUILD_TYPE=Release \\
              -DCMAKE_CXX_STANDARD=23 \\
              -DCMAKE_EXE_LINKER_FLAGS='-static'

            # 4. Build Targets
            # We build both to ensure they compile
            cmake --build . --target LosslessBenchmark -- -j\$(nproc)
            cmake --build . --target LosslessBenchmarkFull -- -j\$(nproc)
            
            # Verify binary type
            echo '=== Binary Verification ==='
            file LosslessBenchmarkFull
            # Should say 'statically linked'
          "

      - name: Verify executables on Host
        run: |
          ls -lh build/LosslessBenchmark
          ls -lh build/LosslessBenchmarkFull
          echo "Binaries are ready and statically linked."

      - name: Upload benchmark executables
        uses: actions/upload-artifact@v4
        with:
          name: neats-linux-benchmarks-static
          path: |
            run_benchmarks.sh
            build/LosslessBenchmark
            build/LosslessBenchmarkFull