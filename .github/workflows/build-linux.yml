name: build-linux

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        flavor: [native, portable]

    env:
      BUILD_TYPE: Release
      CC: gcc-12
      CXX: g++-12
      SQUASH_PREFIX: /usr/local

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build deps
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            git cmake ninja-build pkg-config ccache \
            gcc-12 g++-12 \
            ragel libglib2.0-dev \
            zlib1g-dev libbz2-dev liblzma-dev \
            liblz4-dev libzstd-dev libsnappy-dev libbrotli-dev \
            binutils patchelf

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-${{ runner.os }}-${{ matrix.flavor }}-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.flavor }}-${{ github.ref }}-
            ccache-${{ runner.os }}-${{ matrix.flavor }}-

      - name: Configure ccache
        run: |
          set -euxo pipefail
          ccache --set-config=cache_dir=$HOME/.cache/ccache
          ccache --set-config=max_size=500M
          ccache --zero-stats

      # --------------------------
      # Build & install Squash
      # --------------------------
      - name: Fetch Squash (WITH submodules)
        run: |
          set -euxo pipefail
          rm -rf _deps
          mkdir -p _deps

          # IMPORTANT: recurse submodules, otherwise zlib-ng plugin breaks configure
          git clone --depth 1 --recurse-submodules --shallow-submodules \
            https://github.com/quixdb/squas
