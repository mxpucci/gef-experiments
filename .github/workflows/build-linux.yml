name: build-linux-targeted

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  build-centos7-skylake:
    runs-on: ubuntu-latest
    # 1. THE OS MATCH: Run inside CentOS 7 (glibc 2.17)
    container:
      image: quay.io/pypa/manylinux2014_x86_64:latest

    env:
      BUILD_TYPE: Release
      # 2. THE COMPILER: Use GCC 10 (provided by image) for C++23 support
      CC: /opt/rh/devtoolset-10/root/usr/bin/gcc
      CXX: /opt/rh/devtoolset-10/root/usr/bin/g++
      SQUASH_PREFIX: /usr/local
      # 3. THE HARDWARE MATCH: Target Intel Xeon Gold 6140 (Skylake-Server)
      TARGET_ARCH: "-march=skylake-avx512 -mtune=skylake-avx512"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies (Yum)
        run: |
          # Install build tools and libraries via yum (CentOS package manager)
          yum install -y cmake3 ninja-build libtool \
            zlib-devel bzip2-devel xz-devel lz4-devel libzstd-devel snappy-devel \
            glib2-devel wget

          # Make 'cmake' command point to cmake3
          ln -sf /usr/bin/cmake3 /usr/bin/cmake

      - name: Configure ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-centos7-${{ github.sha }}
          restore-keys: ccache-centos7-

      # --- Build Squash ---
      - name: Checkout Squash
        uses: actions/checkout@v4
        with:
          repository: quixdb/squash
          path: _deps/squash
          submodules: recursive
          fetch-depth: 1

      - name: Build & Install Squash
        run: |
          set -euxo pipefail
          
          # Build Squash with the same compiler settings
          cmake -S _deps/squash -B _deps/squash/build -G Ninja \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX=${SQUASH_PREFIX} \
            -DCMAKE_C_COMPILER=${CC} -DCMAKE_CXX_COMPILER=${CXX} \
            -DCMAKE_C_FLAGS="${TARGET_ARCH}" \
            -DCMAKE_CXX_FLAGS="${TARGET_ARCH}"
            
          cmake --build _deps/squash/build -j
          make -C _deps/squash/build install || cmake --install _deps/squash/build
          
          # Configure dynamic linker
          echo "${SQUASH_PREFIX}/lib" > /etc/ld.so.conf.d/squash.conf
          ldconfig

      # --- Build Your Project ---
      - name: Configure Project (Targeting Skylake)
        run: |
          set -euxo pipefail
          
          # We inject ARCH_FLAGS to override local defaults
          cmake -S . -B build-skylake -G Ninja \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_C_COMPILER=${CC} \
            -DCMAKE_CXX_COMPILER=${CXX} \
            -DARCH_FLAGS="${TARGET_ARCH}" \
            -DNEATS_WITH_SQUASH=ON

      - name: Build Project
        run: cmake --build build-skylake -j

      # --- Bundle ---
      - name: Create Runtime Bundle
        run: |
          set -euxo pipefail
          BIN="build-skylake/LosslessBenchmarkFull"
          OUT="GefExperiments-CentOS7-Skylake"
          
          rm -rf "$OUT"
          mkdir -p "$OUT/lib/squash"
          
          cp -v "$BIN" "$OUT/LosslessBenchmarkFull"
          
          # Install patchelf to fix RPATH
          yum install -y patchelf || echo "patchelf install failed"
          if command -v patchelf; then
             patchelf --set-rpath '$ORIGIN/lib' "$OUT/LosslessBenchmarkFull"
          fi

          # Copy dependencies (Excluding system libs which we know are safe on CentOS 7)
          ldd "$OUT/LosslessBenchmarkFull" | awk '{print $3}' | grep -E '^/' | sort -u > /tmp/libs.txt || true
          while read -r lib; do
            base="$(basename "$lib")"
            case "$base" in
              ld-linux*|libc.so.*|libm.so.*|libpthread.so.*|librt.so.*|libdl.so.*|libstdc++*|libgcc_s*)
                continue ;;
            esac
            cp -vL "$lib" "$OUT/lib/" || true
          done < /tmp/libs.txt

          # Squash Plugins
          cp -r /usr/local/lib/squash/* "$OUT/lib/squash/" || true
          
          # Wrapper Script
          cat << 'EOF' > "$OUT/run.sh"
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "$0")")"
          export SQUASH_PATH="$HERE/lib/squash"
          export LD_LIBRARY_PATH="$HERE/lib:$LD_LIBRARY_PATH"
          exec "$HERE/LosslessBenchmarkFull" "$@"
          EOF
          chmod +x "$OUT/run.sh"

      - name: Upload Bundle
        uses: actions/upload-artifact@v4
        with:
          name: GefExperiments-CentOS7-Skylake
          path: GefExperiments-CentOS7-Skylake
          compression-level: 9